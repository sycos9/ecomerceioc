<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>E-random-Comerç | Llista de Productes</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
            rel="stylesheet"
            />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            />
    </head>
    <body>

        <!-- Barra de navegació -->
        <header class="navbar">
            <a th:href="@{/Random}" class="d-flex align-items-center me-4 text-decoration-none">
                <img src="/images/logo-erandom.png" alt="eRandom Logo" style="height:50px;">
            </a>

            <nav class="nav-links">
                <a th:href="@{/Random}">Inici</a>
                <a th:if="${session.usuari != null and session.usuari.rol.nombre == 'ADMIN'}"
                th:href="@{/Random/productos}">
                Productes
                </a>
                <a href="#">Blog</a>
            </nav>

            <div class="nav-icons">

                <!-- BUSCADOR -->
                <form th:action="@{/Random}" method="get" class="d-flex align-items-center" style="gap: 5px;">
                    <input type="text" 
                           name="busqueda" 
                           placeholder="Cercar..."
                           class="search-bar"
                           th:value="${busqueda}" />
                    <input type="hidden" name="categoria" th:value="${categoriaSeleccionada}" />
                    <button type="submit" class="icon" style="border: none; background: none; cursor: pointer;">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </form>

                <!-- CARRITO -->
                <a th:href="@{/carret}" class="icon">
                    <i class="fa-solid fa-cart-shopping"></i>
                </a>

                <!-- OPCIONS D'USUARI: DEPÈN DE SI ESTÀ LOGUEJAT -->

                <!-- SI NO ESTÀ LOGUEJAT -->
                <a th:if="${session.usuari == null}" th:href="@{/login}" class="btn btn-sm btn-outline-success">
                    Inicia sessió
                </a>

                <!-- SI ESTÀ LOGUEJAT: MOSTRA NOM I BOTÓ LOGOUT -->
                <div th:if="${session.usuari != null}" class="d-flex align-items-center gap-2">
                    <span class="fw-semibold" th:text="${session.usuari.username}"></span>
                    <a th:href="@{/logout}" class="btn btn-sm btn-outline-danger">
                        Tanca sessió
                    </a>
                </div>

            </div>
        </header>

        <div class="container mt-5">
            <!-- Mensaje de éxito -->
            <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fa-solid fa-circle-check"></i>
                <span th:text="${mensaje}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Llista de Productes</h2>
                <!-- Botón para añadir producto -->
                <a th:href="@{/Random/productos/nuevo}" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i> Afegeix un Producte
                </a>
            </div>

            <!-- Mostrar total de productos -->
            <p th:if="${productos != null and !productos.isEmpty()}" class="text-muted">
                Total de productes: <strong th:text="${productos.size()}">0</strong>
            </p>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Imatge</th>
                        <th>Codi</th>
                        <th>Nom</th>
                        <th>Descripció</th>
                        <th>Preu</th>
                        <th>Stock</th>
                        <th>Categoria</th>
                        <th>Accions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Si hay productos, los muestra -->
                    <tr th:each="producto : ${productos}">
                        <td>
                            <img th:if="${producto.imagen != null and !producto.imagen.isEmpty()}"
                                 th:src="@{/Random/productos/imagenes/{nombre}(nombre=${producto.imagen})}"
                                 alt="Imagen del producto"
                                 class="img-thumbnail"
                                 style="max-width: 80px; max-height: 80px; object-fit: cover;">
                            <span th:if="${producto.imagen == null or producto.imagen.isEmpty()}" 
                                  class="text-muted">
                                <i class="fa-solid fa-image"></i> Sense imatge
                            </span>
                        </td>
                        <td th:text="${producto.codigo}">P001</td>
                        <td th:text="${producto.nombre}">Producte</td>
                        <td th:text="${producto.descripcion}">Descripció</td>
                        <td th:text="${'€' + #numbers.formatDecimal(producto.precio, 1, 2)}">€10.00</td>
                        <td th:text="${producto.stock}">100</td>
                        <td th:text="${producto.categoria}">Categoria</td>
                        <td>
                            <a th:href="@{/Random/productos/editar/{id}(id=${producto.id})}" class="btn btn-warning btn-sm">
                                <i class="fa-solid fa-edit"></i>
                            </a>
                            <a href="#" class="btn btn-danger btn-sm"
                               th:data-id="${producto.id}" 
                               th:data-nombre="${producto.nombre}" 
                               onclick="eliminarProducto(this)">
                                <i class="fa-solid fa-trash"></i>
                            </a>

                        </td>
                    </tr>

                    <!-- Si no hay productos -->
                    <tr th:if="${productos == null or productos.isEmpty()}">
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fa-solid fa-box-open fa-3x mb-3"></i>
                            <p>No hi ha productes registrats</p>
                            <a th:href="@{/Random/productos/nuevo}" class="btn btn-sm btn-primary">
                                Afegeix el primer producte
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <footer class="footer">
            <div class="footer-links">
                <div>
                    <h4>Sobre nosaltres</h4>
                    <a href="#">Blog</a>
                    <a href="#">Equip</a>
                </div>
                <div>
                    <h4>Ajuda</h4>
                    <a href="#">Contacte</a>
                    <a href="#">Enviaments</a>
                    <a href="#">Retorns</a>
                </div>
            </div>
            <p class="copyright">© 2025 E-random-Comerç. Tots els drets reservats.</p>
        </footer>

        <!-- Bootstrap JS para cerrar alertas -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <!-- Confirmación Swal -->
        <script>
                                   function eliminarProducto(element) {
                                       const id = element.dataset.id;
                                       const nombre = element.dataset.nombre;

                                       Swal.fire({
                                           title: '¿Estás seguro?',
                                           text: "Vols eliminar el producte: " + nombre,
                                           icon: 'warning',
                                           showCancelButton: true,
                                           confirmButtonColor: '#d33',
                                           cancelButtonColor: '#3085d6',
                                           confirmButtonText: 'Eliminar',
                                           cancelButtonText: 'Cancelar'
                                       }).then((result) => {
                                           if (result.isConfirmed) {
                                               window.location.href = '/Random/productos/eliminar/' + id;
                                           }
                                       });
                                   }

        </script>

    </body>
</html>
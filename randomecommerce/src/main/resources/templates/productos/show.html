<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${producto.nombre} + ' - E-random-Comerç'">Detall del Producte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
</head>
<body>
<header class="navbar">
    <a th:href="@{/Random}" class="d-flex align-items-center me-4 text-decoration-none">
        <img src="/images/logo-erandom.png" alt="eRandom Logo" style="height:50px;">
    </a>

    <nav class="nav-links">
        <a th:href="@{/Random}">Inici</a>
        <a th:if="${session.usuari != null and session.usuari.rol.nombre == 'ADMIN'}"
           th:href="@{/Random/productos}">Productes</a>
        <a href="#">Blog</a>
    </nav>

    <div class="nav-icons">
        <form th:action="@{/Random}" method="get" class="d-flex align-items-center" style="gap:5px;">
            <input type="text" name="busqueda" placeholder="Cercar..." class="search-bar" th:value="${busqueda}" />
            <input type="hidden" name="categoria" th:value="${categoriaSeleccionada}" />
            <button type="submit" class="icon" style="border:none;background:none;cursor:pointer;">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </form>
        <a th:href="@{/Random/carrito}" class="icon"><i class="fa-solid fa-cart-shopping"></i></a>

        <a th:if="${session.usuari == null}" th:href="@{/login}" class="btn btn-sm btn-outline-success">Inicia sessió</a>

        <div th:if="${session.usuari != null}" class="d-flex align-items-center gap-2">
            <span class="fw-semibold" th:text="${session.usuari.username}"></span>
            <a th:href="@{/logout}" class="btn btn-sm btn-outline-danger">Tanca sessió</a>
        </div>
    </div>
</header>

<div class="container mt-5 mb-5">
    <a th:href="@{/Random(categoria=${categoriaSeleccionada}, busqueda=${busqueda})}" class="btn btn-secondary mb-4">
        <i class="fa-solid fa-arrow-left"></i> Tornar a la botiga
    </a>

    <div th:if="${mensajeCarrito}" class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-cart-shopping"></i>
        <span th:text="${mensajeCarrito}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorCarrito}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span th:text="${errorCarrito}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- Imagen del producto -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div style="height:500px;overflow:hidden;background-color:#f8f9fa;display:flex;align-items:center;justify-content:center;">
                    <img th:if="${producto.imagen != null and !producto.imagen.isEmpty()}"
                         th:src="@{/Random/productos/imagenes/{nombre}(nombre=${producto.imagen})}"
                         th:alt="${producto.nombre}" style="width:100%;height:100%;object-fit:cover;">
                    <span th:if="${producto.imagen == null or producto.imagen.isEmpty()}" class="text-muted">
                        <i class="fa-solid fa-image fa-5x"></i>
                    </span>
                </div>
            </div>
        </div>

        <!-- Información del producto -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="mb-3">
                        <span class="text-muted small" th:text="${producto.codigo}">COD</span>
                        <span class="badge bg-secondary ms-2" th:text="${producto.categoria}">Categoria</span>
                    </div>

                    <h1 class="card-title mb-3" th:text="${producto.nombre}">Nom del producte</h1>

                    <div class="mb-4">
                        <h2 class="text-primary fw-bold" th:text="${'€' + #numbers.formatDecimal(producto.precio,1,2)}">€0.00</h2>
                    </div>

                    <div class="mb-4">
                        <h5>Descripció</h5>
                        <p class="text-muted" th:text="${producto.descripcion != null and !producto.descripcion.isEmpty()} ? ${producto.descripcion} : 'No hay descripción disponible.'">
                            Descripció del producte
                        </p>
                    </div>

                    <!-- Stock y boton -->
                    <th:block th:with="stockDisponible=${producto.stock - carrito.getCantidadEnCarrito(producto.id)}">
                        <p th:class="${stockDisponible > 0} ? 'text-success fw-bold' : 'text-danger fw-bold'">
                            <span th:if="${stockDisponible > 0}" th:text="${stockDisponible + ' unitats disponibles'}"></span>
                            <span th:if="${stockDisponible <= 0}" class="text-danger">Sense stock</span>
                        </p>
                        
                        <div class="d-grid gap-2">
                            <button th:if="${stockDisponible > 0}" type="button"
                                    class="btn btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalCantidad"
                                    th:attr="data-producto-id=${producto.id}, data-stock=${stockDisponible}">
                                Añadir al carrito
                            </button>
                            <button th:if="${stockDisponible <= 0}" type="button" class="btn btn-secondary" disabled>
                                Sense stock disponible
                            </button>
                        </div>
                    </th:block>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modalCantidad" tabindex="-1" aria-labelledby="modalCantidadLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formAgregar" method="post" th:action="@{/Random/carrito/agregar/__id__}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCantidadLabel">Selecciona cantidad</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Stock disponible: <span id="stockDisponible"></span></p>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-secondary btn-sm" id="restar">-</button>
                            <input id="cantidadInput" type="number" name="cantidad" class="form-control" min="1" value="1">
                            <button type="button" class="btn btn-secondary btn-sm" id="sumar">+</button>
                        </div>
                        <input type="hidden" name="redirectUrl" th:value="@{|/Random/productos/${producto.id}|}" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-links">
        <div>
            <h4>Sobre nosaltres</h4>
            <a href="#">Blog</a>
            <a href="#">Equip</a>
        </div>
        <div>
            <h4>Ajuda</h4>
            <a href="#">Contacte</a>
            <a href="#">Enviaments</a>
            <a href="#">Retorns</a>
        </div>
    </div>
    <p class="copyright">© 2025 E-random-Comerç. Tots els drets reservats.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("modalCantidad");
    const cantidadInput = document.getElementById("cantidadInput");
    const stockDisponibleSpan = document.getElementById("stockDisponible");
    const btnSumar = document.getElementById("sumar");
    const btnRestar = document.getElementById("restar");
    const form = document.getElementById("formAgregar");

    let btnAbrirModal;

    modal.addEventListener("show.bs.modal", (event) => {
        btnAbrirModal = event.relatedTarget;
        const stockDisponible = parseInt(btnAbrirModal.getAttribute("data-stock"), 10);
        const idProducto = btnAbrirModal.getAttribute("data-producto-id");

        stockDisponibleSpan.textContent = stockDisponible;
        cantidadInput.value = 1;
        cantidadInput.max = stockDisponible;

        form.setAttribute("action", `/Random/carrito/agregar/${idProducto}`);
    });

    btnSumar.addEventListener("click", () => {
        const max = parseInt(cantidadInput.max,10);
        let val = parseInt(cantidadInput.value,10);
        if(val < max) cantidadInput.value = val + 1;
    });

    btnRestar.addEventListener("click", () => {
        let val = parseInt(cantidadInput.value,10);
        if(val > 1) cantidadInput.value = val -1;
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const cantidad = parseInt(formData.get('cantidad'),10);

        try {
            const response = await fetch(form.action, { method:'POST', body: formData });
            if(response.ok){
                const stockActual = parseInt(btnAbrirModal.getAttribute('data-stock'),10);
                const nuevoStock = stockActual - cantidad;

                // cerrar modal
                bootstrap.Modal.getInstance(modal).hide();

                // mensaje
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `<i class="fa-solid fa-cart-shopping"></i> S'ha afegit ${cantidad} unitat(s) al carret!
                                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
                setTimeout(()=>alertDiv.remove(),3000);

                // actualizar stock del boton y cantidad en carrito
                const stockSection = btnAbrirModal.closest('.card-body');
                const carritoInfo = stockSection.querySelector('.text-info span');
                if(carritoInfo){
                    let cantActual = parseInt(carritoInfo.textContent);
                    carritoInfo.textContent = (cantActual + cantidad) + ' unitats al carret';
                } else {
                    const div = document.createElement('div');
                    div.className = 'mt-2';
                    div.innerHTML = `<p class="text-info fw-bold"><i class="fa-solid fa-cart-shopping"></i> <span>${cantidad} unitats al carret</span></p>`;
                    stockSection.appendChild(div);
                }

                if(nuevoStock <= 0){
                    const container = btnAbrirModal.parentElement;
                    const newBtn = document.createElement('button');
                    newBtn.type = 'button';
                    newBtn.className = 'btn btn-secondary';
                    newBtn.disabled = true;
                    newBtn.textContent = 'Sense stock disponible';
                    container.replaceChild(newBtn, btnAbrirModal);
                } else {
                    btnAbrirModal.setAttribute('data-stock', nuevoStock);
                }
            } else {
                alert('Error al afegir al carret');
            }
        } catch(e){
            console.error(e);
            alert('Error de connexió');
        }
    });
});
</script>
</body>
</html>